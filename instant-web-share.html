<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Instant Web Page Share</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background-color: #f9fafb;
            color: #111827;
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden;
        }
        .editor-container {
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        .code-editor {
            flex: 1;
            font-family: 'Menlo', 'Monaco', 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
            padding: 1rem;
            resize: none;
            border: none;
            background-color: #1e1e1e;
            color: #d4d4d4;
            outline: none;
            tab-size: 2;
        }
        .preview-container {
            height: 100%;
            display: flex;
            flex-direction: column;
            background-color: white;
            border-left: 1px solid #e5e7eb;
        }
        .preview-iframe {
            flex: 1;
            border: none;
            width: 100%;
            height: 100%;
            background-color: white;
        }
        .toolbar {
            display: flex;
            align-items: center;
            padding: 0.5rem 1rem;
            background-color: #f3f4f6;
            border-bottom: 1px solid #e5e7eb;
        }
        .toolbar-button {
            padding: 0.5rem 1rem;
            background-color: #2563eb;
            color: white;
            border: none;
            border-radius: 0.375rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-right: 0.5rem;
        }
        .toolbar-button:hover {
            background-color: #1d4ed8;
        }
        .toolbar-button:disabled {
            background-color: #93c5fd;
            cursor: not-allowed;
        }
        .toolbar-select {
            padding: 0.5rem;
            border-radius: 0.375rem;
            border: 1px solid #d1d5db;
            margin-right: 0.5rem;
            background-color: white;
        }
        .share-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
            visibility: hidden;
            opacity: 0;
            transition: visibility 0s linear 0.2s, opacity 0.2s;
        }
        .share-container.visible {
            visibility: visible;
            opacity: 1;
            transition-delay: 0s;
        }
        .share-dialog {
            background-color: white;
            border-radius: 0.5rem;
            padding: 1.5rem;
            width: 90%;
            max-width: 32rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .share-input {
            width: 100%;
            padding: 0.75rem;
            border-radius: 0.375rem;
            border: 1px solid #d1d5db;
            margin-top: 0.5rem;
            margin-bottom: 1rem;
            font-family: monospace;
        }
        .share-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
        }
        .share-button {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 500;
            cursor: pointer;
        }
        .share-button.primary {
            background-color: #2563eb;
            color: white;
            border: none;
        }
        .share-button.secondary {
            background-color: white;
            color: #4b5563;
            border: 1px solid #d1d5db;
        }
        .toast {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            padding: 1rem;
            background-color: #10b981;
            color: white;
            border-radius: 0.375rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            z-index: 50;
            visibility: hidden;
            opacity: 0;
            transition: visibility 0s linear 0.2s, opacity 0.2s;
        }
        .toast.visible {
            visibility: visible;
            opacity: 1;
            transition-delay: 0s;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            visibility: hidden;
            opacity: 0;
            transition: visibility 0s linear 0.2s, opacity 0.2s;
        }
        .loading-overlay.visible {
            visibility: visible;
            opacity: 1;
            transition-delay: 0s;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #2563eb;
            border-radius: 50%;
            width: 2rem;
            height: 2rem;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
        /* Status indicator */
        .status-indicator {
            display: flex;
            align-items: center;
            margin-left: auto;
            margin-right: 1rem;
            font-size: 0.875rem;
        }
        .status-dot {
            height: 0.5rem;
            width: 0.5rem;
            border-radius: 50%;
            margin-right: 0.5rem;
        }
        .status-dot.connected {
            background-color: #10b981;
        }
        .status-dot.disconnected {
            background-color: #ef4444;
        }
        /* Error message */
        .error-container {
            padding: 1rem;
            border-top: 1px solid #e5e7eb;
            background-color: #fff1f2;
            color: #ef4444;
            font-size: 0.875rem;
            overflow-y: auto;
            max-height: 150px;
        }
        /* Templates dropdown */
        .template-dropdown {
            position: relative;
            display: inline-block;
        }
        .template-dropdown-content {
            display: none;
            position: absolute;
            background-color: white;
            min-width: 200px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            z-index: 51;
            border-radius: 0.375rem;
            border: 1px solid #e5e7eb;
        }
        .template-dropdown:hover .template-dropdown-content {
            display: block;
        }
        .template-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
        }
        .template-item:hover {
            background-color: #f3f4f6;
        }
    </style>
</head>
<body>
    <div class="flex h-screen">
        <!-- Left panel: Code editor -->
        <div class="w-1/2 editor-container">
            <div class="toolbar">
                <select id="language-select" class="toolbar-select">
                    <option value="html">HTML</option>
                    <option value="css">CSS</option>
                    <option value="javascript">JavaScript</option>
                    <option value="typescript">TypeScript</option>
                    <option value="jsx">JSX</option>
                    <option value="tsx" selected>TSX</option>
                </select>
                <button id="run-button" class="toolbar-button">
                    Run
                </button>
                <button id="share-button" class="toolbar-button bg-green-600 hover:bg-green-700">
                    Share
                </button>
                
                <div class="template-dropdown ml-2">
                    <button class="toolbar-button bg-purple-600 hover:bg-purple-700">
                        Templates
                    </button>
                    <div class="template-dropdown-content">
                        <div class="template-item" id="template-basic-tsx">Basic React TSX</div>
                        <div class="template-item" id="template-chart">Recharts Example</div>
                        <div class="template-item" id="template-legislative">Legislative Compliance Chart</div>
                    </div>
                </div>
                
                <div class="status-indicator">
                    <div id="status-dot" class="status-dot disconnected"></div>
                    <span id="status-text">Offline</span>
                </div>
            </div>
            <textarea id="code-editor" class="code-editor" spellcheck="false">import React, { useState } from 'react';
import { RadarChart, PolarGrid, PolarAngleAxis, PolarRadiusAxis, Radar, Legend, ResponsiveContainer } from 'recharts';

const LegislationBreakdown = () => {
  const data = [
    {
      legislation: 'Equality Act S20-21',
      Ben: 100,
      Newlyn: 10,
      Westminster: 5,
      Integrity: 0
    },
    {
      legislation: 'Care Act S6',
      Ben: 100,
      Newlyn: 15,
      Westminster: 10,
      Integrity: 10
    },
    {
      legislation: 'TCOG Regulations',
      Ben: 100,
      Newlyn: 25,
      Westminster: 20,
      Integrity: 0
    },
    {
      legislation: 'PSED (S149)',
      Ben: 100,
      Newlyn: 15,
      Westminster: 5,
      Integrity: 5
    },
    {
      legislation: 'HRA Article 6',
      Ben: 100,
      Newlyn: 10,
      Westminster: 10,
      Integrity: 10
    },
  ];

  return (
    <div className="w-full bg-white p-6 rounded-lg shadow-lg">
      <h2 className="text-2xl font-bold mb-4 text-center text-gray-800">Legislative Compliance Analysis (%)</h2>
      <div className="border-b border-gray-200 mb-6"></div>

      <div style={{ width: '100%', height: 500 }}>
        <ResponsiveContainer>
          <RadarChart cx="50%" cy="50%" outerRadius="80%" data={data}>
            <PolarGrid gridType="polygon" />
            <PolarAngleAxis dataKey="legislation" tick={{ fill: '#374151', fontSize: 14 }} />
            <PolarRadiusAxis angle={30} domain={[0, 100]} />
            <Radar name="Ben Mak" dataKey="Ben" stroke="#10B981" fill="#10B981" fillOpacity={0.3} />
            <Radar name="Newlyn PLC" dataKey="Newlyn" stroke="#3B82F6" fill="#3B82F6" fillOpacity={0.3} />
            <Radar name="Westminster" dataKey="Westminster" stroke="#F59E0B" fill="#F59E0B" fillOpacity={0.3} />
            <Radar name="Integrity" dataKey="Integrity" stroke="#EF4444" fill="#EF4444" fillOpacity={0.3} />
            <Legend wrapperStyle={{ paddingTop: '20px' }} />
          </RadarChart>
        </ResponsiveContainer>
      </div>

      <div className="mt-6 text-sm text-gray-600 bg-gray-50 p-4 rounded-md">
        <p className="font-medium mb-2">Key Legislation:</p>
        <div className="grid grid-cols-1 md:grid-cols-2 gap-2">
          <div>
            <p><strong>Equality Act S20-21:</strong> Duty to make reasonable adjustments</p>
            <p><strong>Care Act S6:</strong> Duty to cooperate</p>
            <p><strong>TCOG Regulations:</strong> Taking Control of Goods Regulations</p>
          </div>
          <div>
            <p><strong>PSED (S149):</strong> Public Sector Equality Duty</p>
            <p><strong>HRA Article 6:</strong> Right to fair hearing</p>
          </div>
        </div>
        <p className="mt-2"><strong>Note:</strong> The transcripts show Ben maintains perfect compliance with all legal responsibilities despite facing extraordinary barriers.</p>
      </div>
    </div>
  );
};

export default LegislationBreakdown;</textarea>
        </div>

        <!-- Right panel: Preview -->
        <div class="w-1/2 preview-container">
            <div class="toolbar">
                <span class="font-medium">Preview</span>
                <div class="flex-grow"></div>
                <select id="preview-device" class="toolbar-select">
                    <option value="desktop">Desktop</option>
                    <option value="tablet">Tablet</option>
                    <option value="mobile">Mobile</option>
                </select>
                <button id="refresh-button" class="toolbar-button">
                    Refresh
                </button>
            </div>
            <iframe id="preview" class="preview-iframe" sandbox="allow-scripts allow-same-origin allow-forms" style="width: 100%;"></iframe>
            <div id="error-container" class="error-container hidden">
                <h3 class="font-bold mb-2">Error</h3>
                <pre id="error-message" class="whitespace-pre-wrap"></pre>
            </div>
        </div>
    </div>

    <!-- Share dialog -->
    <div id="share-container" class="share-container">
        <div class="share-dialog">
            <h2 class="text-xl font-bold mb-4">Share Your Page</h2>
            <p class="mb-2">Your page is now live at:</p>
            <input id="share-url" class="share-input" type="text" readonly>
            <div class="share-buttons">
                <button id="copy-button" class="share-button primary">
                    Copy Link
                </button>
                <button id="close-button" class="share-button secondary">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Toast notification -->
    <div id="toast" class="toast">
        Link copied to clipboard!
    </div>

    <!-- Loading overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="spinner"></div>
    </div>

    <script>
        // DOM elements
        const codeEditor = document.getElementById('code-editor');
        const languageSelect = document.getElementById('language-select');
        const runButton = document.getElementById('run-button');
        const refreshButton = document.getElementById('refresh-button');
        const preview = document.getElementById('preview');
        const previewDevice = document.getElementById('preview-device');
        const shareButton = document.getElementById('share-button');
        const shareContainer = document.getElementById('share-container');
        const shareUrl = document.getElementById('share-url');
        const copyButton = document.getElementById('copy-button');
        const closeButton = document.getElementById('close-button');
        const toast = document.getElementById('toast');
        const loadingOverlay = document.getElementById('loading-overlay');
        const statusDot = document.getElementById('status-dot');
        const statusText = document.getElementById('status-text');
        const errorContainer = document.getElementById('error-container');
        const errorMessage = document.getElementById('error-message');
        
        // Template buttons
        const templateBasicTsx = document.getElementById('template-basic-tsx');
        const templateChart = document.getElementById('template-chart');
        const templateLegislative = document.getElementById('template-legislative');

        // Template content
        const templates = {
            'basic-tsx': `import React, { useState } from 'react';

const Button = ({ text, onClick }) => {
  return (
    <button 
      onClick={onClick} 
      className="mt-4 px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700"
    >
      {text}
    </button>
  );
};

const App = () => {
  const [count, setCount] = useState(0);
  
  const increment = () => {
    setCount(count + 1);
  };
  
  return (
    <div className="bg-gray-100 min-h-screen flex items-center justify-center">
      <div className="max-w-md mx-auto bg-white rounded-xl shadow-md overflow-hidden md:max-w-2xl m-4">
        <div className="p-8">
          <div className="uppercase tracking-wide text-sm text-indigo-500 font-semibold">
            React Demo
          </div>
          <h1 className="block mt-1 text-lg leading-tight font-medium text-black">
            Simple Counter Application
          </h1>
          <p className="mt-2 text-gray-500">
            This is a simple counter app built with React.
          </p>
          <div className="mt-4 text-2xl font-bold">Count: {count}</div>
          <Button text="Increment" onClick={increment} />
        </div>
      </div>
    </div>
  );
};

export default App;`,
            'chart': `import React from 'react';
import { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } from 'recharts';

const WebsiteStats = () => {
  const data = [
    { name: 'Jan', visitors: 4000, pageViews: 2400, amt: 2400 },
    { name: 'Feb', visitors: 3000, pageViews: 1398, amt: 2210 },
    { name: 'Mar', visitors: 2000, pageViews: 9800, amt: 2290 },
    { name: 'Apr', visitors: 2780, pageViews: 3908, amt: 2000 },
    { name: 'May', visitors: 1890, pageViews: 4800, amt: 2181 },
    { name: 'Jun', visitors: 2390, pageViews: 3800, amt: 2500 },
    { name: 'Jul', visitors: 3490, pageViews: 4300, amt: 2100 },
  ];

  return (
    <div className="bg-white p-6 rounded-lg shadow-lg">
      <h2 className="text-2xl font-bold mb-6">Website Analytics</h2>
      
      <div style={{ width: '100%', height: 400 }}>
        <ResponsiveContainer>
          <LineChart
            data={data}
            margin={{ top: 5, right: 30, left: 20, bottom: 5 }}
          >
            <CartesianGrid strokeDasharray="3 3" />
            <XAxis dataKey="name" />
            <YAxis />
            <Tooltip />
            <Legend />
            <Line type="monotone" dataKey="pageViews" stroke="#8884d8" activeDot={{ r: 8 }} />
            <Line type="monotone" dataKey="visitors" stroke="#82ca9d" />
          </LineChart>
        </ResponsiveContainer>
      </div>
      
      <div className="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4">
        <div className="bg-purple-50 p-4 rounded-md">
          <h3 className="text-lg font-semibold text-purple-700">Total Page Views</h3>
          <p className="text-3xl font-bold">26,406</p>
        </div>
        <div className="bg-green-50 p-4 rounded-md">
          <h3 className="text-lg font-semibold text-green-700">Total Visitors</h3>
          <p className="text-3xl font-bold">17,550</p>
        </div>
      </div>
    </div>
  );
};

export default WebsiteStats;`,
            'legislative': `import React from 'react';
import { RadarChart, PolarGrid, PolarAngleAxis, PolarRadiusAxis, Radar, Legend, ResponsiveContainer } from 'recharts';

const LegislationBreakdown = () => {
  const data = [
    {
      legislation: 'Equality Act S20-21',
      Ben: 100,
      Newlyn: 10,
      Westminster: 5,
      Integrity: 0
    },
    {
      legislation: 'Care Act S6',
      Ben: 100,
      Newlyn: 15,
      Westminster: 10,
      Integrity: 10
    },
    {
      legislation: 'TCOG Regulations',
      Ben: 100,
      Newlyn: 25,
      Westminster: 20,
      Integrity: 0
    },
    {
      legislation: 'PSED (S149)',
      Ben: 100,
      Newlyn: 15,
      Westminster: 5,
      Integrity: 5
    },
    {
      legislation: 'HRA Article 6',
      Ben: 100,
      Newlyn: 10,
      Westminster: 10,
      Integrity: 10
    },
  ];

  return (
    <div className="w-full bg-white p-6 rounded-lg shadow-lg">
      <h2 className="text-2xl font-bold mb-4 text-center text-gray-800">Legislative Compliance Analysis (%)</h2>
      <div className="border-b border-gray-200 mb-6"></div>

      <div style={{ width: '100%', height: 500 }}>
        <ResponsiveContainer>
          <RadarChart cx="50%" cy="50%" outerRadius="80%" data={data}>
            <PolarGrid gridType="polygon" />
            <PolarAngleAxis dataKey="legislation" tick={{ fill: '#374151', fontSize: 14 }} />
            <PolarRadiusAxis angle={30} domain={[0, 100]} />
            <Radar name="Ben Mak" dataKey="Ben" stroke="#10B981" fill="#10B981" fillOpacity={0.3} />
            <Radar name="Newlyn PLC" dataKey="Newlyn" stroke="#3B82F6" fill="#3B82F6" fillOpacity={0.3} />
            <Radar name="Westminster" dataKey="Westminster" stroke="#F59E0B" fill="#F59E0B" fillOpacity={0.3} />
            <Radar name="Integrity" dataKey="Integrity" stroke="#EF4444" fill="#EF4444" fillOpacity={0.3} />
            <Legend wrapperStyle={{ paddingTop: '20px' }} />
          </RadarChart>
        </ResponsiveContainer>
      </div>

      <div className="mt-6 text-sm text-gray-600 bg-gray-50 p-4 rounded-md">
        <p className="font-medium mb-2">Key Legislation:</p>
        <div className="grid grid-cols-1 md:grid-cols-2 gap-2">
          <div>
            <p><strong>Equality Act S20-21:</strong> Duty to make reasonable adjustments</p>
            <p><strong>Care Act S6:</strong> Duty to cooperate</p>
            <p><strong>TCOG Regulations:</strong> Taking Control of Goods Regulations</p>
          </div>
          <div>
            <p><strong>PSED (S149):</strong> Public Sector Equality Duty</p>
            <p><strong>HRA Article 6:</strong> Right to fair hearing</p>
          </div>
        </div>
        <p className="mt-2"><strong>Note:</strong> The transcripts show Ben maintains perfect compliance with all legal responsibilities despite facing extraordinary barriers. He consistently cites applicable legislation, clearly articulates his rights, documents all interactions, and attempts multiple approaches to navigate complex systems that fail to provide legally required accommodations.</p>
      </div>
    </div>
  );
};

export default LegislationBreakdown;`
        };

        // Simulate online status for demo
        setTimeout(() => {
            statusDot.classList.remove('disconnected');
            statusDot.classList.add('connected');
            statusText.textContent = 'Connected';
        }, 1000);

        // Function to create a React template with all necessary imports
        function createReactTemplate(code, language) {
            // Basic HTML template with React and necessary libraries
            return `
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Preview</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React and ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- For chart libraries -->
    <script src="https://unpkg.com/prop-types/prop-types.min.js"></script>
    <script src="https://unpkg.com/recharts/umd/Recharts.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }
        #root {
            min-height: 100vh;
        }
        .error-display {
            padding: 20px;
            color: #e53e3e;
            background-color: #fff5f5;
            border-left: 4px solid #e53e3e;
            margin: 20px;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        // Access React and ReactDOM from window to ensure consistency
        const React = window.React;
        const ReactDOM = window.ReactDOM;
        const { useState, useEffect } = React;
        
        // For Recharts components if needed
        const Recharts = window.Recharts;
        const {
            RadarChart, PolarGrid, PolarAngleAxis, PolarRadiusAxis, Radar, Legend, ResponsiveContainer,
            LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip
        } = Recharts;
        
        // The user component code
        ${code}
        
        // The main App component that will be rendered
        const AppWrapper = () => {
            const [error, setError] = React.useState(null);
            
            React.useEffect(() => {
                // Try to handle any errors during mounting
                try {
                    // Check if the component exports a default
                    if (typeof LegislationBreakdown !== 'undefined') {
                        return () => {};
                    } else if (typeof App !== 'undefined') {
                        return () => {};
                    } else if (typeof WebsiteStats !== 'undefined') {
                        return () => {};
                    }
                } catch (err) {
                    setError(err);
                    console.error(err);
                    // Report back to parent frame
                    window.parent.postMessage({ type: 'error', message: err.message }, '*');
                }
            }, []);
            
            if (error) {
                return (
                    <div className="error-display">
                        <h2>Error Rendering Component</h2>
                        <pre>{error.message}</pre>
                    </div>
                );
            }
            
            // Try to render the component based on what's available
            try {
                // Check for common component names
                if (typeof LegislationBreakdown !== 'undefined') {
                    return <LegislationBreakdown />;
                } else if (typeof App !== 'undefined') {
                    return <App />;
                } else if (typeof WebsiteStats !== 'undefined') {
                    return <WebsiteStats />;
                } else {
                    // No recognized component found
                    return (
                        <div className="error-display">
                            <h2>Component Not Found</h2>
                            <p>Make sure your component has a default export or is named App, LegislationBreakdown, or WebsiteStats.</p>
                        </div>
                    );
                }
            } catch (err) {
                return (
                    <div className="error-display">
                        <h2>Error Rendering Component</h2>
                        <pre>{err.message}</pre>
                    </div>
                );
            }
        };
        
        // Render the app safely
        try {
            const root = ReactDOM.createRoot ? 
                ReactDOM.createRoot(document.getElementById('root')) : 
                { render: (element) => ReactDOM.render(element, document.getElementById('root')) };
                
            root.render(<AppWrapper />);
        } catch (err) {
            console.error('Error rendering:', err);
            document.getElementById('root').innerHTML = \`
                <div class="error-display">
                    <h2>Error Rendering Application</h2>
                    <pre>\${err.message}</pre>
                </div>
            \`;
            // Report back to parent frame
            window.parent.postMessage({ type: 'error', message: err.message }, '*');
        }
    </script>
</body>
</html>`;
        }

        // Update preview
        function updatePreview() {
            // Hide any previous error
            errorContainer.classList.add('hidden');
            errorMessage.textContent = '';
            
            try {
                // Get the code and language
                const code = codeEditor.value;
                const language = languageSelect.value;
                
                // For JSX and TSX, use our React template
                if (language === 'jsx' || language === 'tsx') {
                    const previewTemplate = createReactTemplate(code, language);
                    
                    // Update the iframe
                    const previewDocument = preview.contentDocument;
                    previewDocument.open();
                    previewDocument.write(previewTemplate);
                    previewDocument.close();
                } else {
                    // For other languages, use a simpler approach
                    const previewDocument = preview.contentDocument;
                    previewDocument.open();
                    
                    if (language === 'html') {
                        // Just use the HTML directly
                        previewDocument.write(code);
                    } else if (language === 'css') {
                        // Wrap CSS in a basic HTML document
                        previewDocument.write(`
                            <!DOCTYPE html>
                            <html>
                            <head>
                                <style>${code}</style>
                            </head>
                            <body>
                                <div class="container">
                                    <h1>CSS Preview</h1>
                                    <p>Add HTML elements or classes in your CSS to see styling applied.</p>
                                </div>
                            </body>
                            </html>
                        `);
                    } else if (language === 'javascript' || language === 'typescript') {
                        // Wrap JS in a basic HTML document with console output
                        previewDocument.write(`
                            <!DOCTYPE html>
                            <html>
                            <head>
                                <style>
                                    body { font-family: sans-serif; padding: 20px; }
                                    #output { border: 1px solid #e2e8f0; padding: 10px; margin-top: 20px; }
                                    .log { margin-bottom: 5px; border-bottom: 1px solid #edf2f7; padding-bottom: 5px; }
                                    .error { color: #e53e3e; }
                                </style>
                            </head>
                            <body>
                                <h3>JavaScript Output:</h3>
                                <div id="output"></div>
                                <script>
                                    // Redirect console to the output div
                                    const output = document.getElementById('output');
                                    
                                    // Override console.log
                                    const originalLog = console.log;
                                    console.log = function(...args) {
                                        originalLog.apply(console, args);
                                        const logItem = document.createElement('div');
                                        logItem.className = 'log';
                                        logItem.textContent = args.map(arg => 
                                            typeof arg === 'object' ? JSON.stringify(arg) : String(arg)
                                        ).join(' ');
                                        output.appendChild(logItem);
                                    };
                                    
                                    // Override console.error
                                    const originalError = console.error;
                                    console.error = function(...args) {
                                        originalError.apply(console, args);
                                        const errorItem = document.createElement('div');
                                        errorItem.className = 'log error';
                                        errorItem.textContent = 'ERROR: ' + args.map(arg => 
                                            typeof arg === 'object' ? JSON.stringify(arg) : String(arg)
                                        ).join(' ');
                                        output.appendChild(errorItem);
                                    };
                                    
                                    // Run the code
                                    try {
                                        ${code}
                                    } catch (error) {
                                        console.error(error.message);
                                    }
                                </script>
                            </body>
                            </html>
                        `);
                    }
                    
                    previewDocument.close();
                }
            } catch (error) {
                console.error('Error updating preview:', error);
                showError('Error updating preview: ' + error.message);
            }
        }
        
        // Listen for error messages from the iframe
        window.addEventListener('message', function(event) {
            if (event.data && event.data.type === 'error') {
                showError(event.data.message);
            }
        });
        
        // Show error message
        function showError(message) {
            errorContainer.classList.remove('hidden');
            errorMessage.textContent = message;
        }

        // Run button
        runButton.addEventListener('click', updatePreview);

        // Refresh button
        refreshButton.addEventListener('click', updatePreview);

        // Device preview
        previewDevice.addEventListener('change', function() {
            switch(this.value) {
                case 'desktop':
                    preview.style.width = '100%';
                    break;
                case 'tablet':
                    preview.style.width = '768px';
                    break;
                case 'mobile':
                    preview.style.width = '375px';
                    break;
            }
        });

        // Share functionality
        shareButton.addEventListener('click', async function() {
            // Show loading overlay
            loadingOverlay.classList.add('visible');

            try {
                // Get the code
                const code = codeEditor.value;
                const language = languageSelect.value;

                // Create a unique ID for the page
                const pageId = Date.now().toString(36) + Math.random().toString(36).substring(2);

                // In a real implementation, this would send the code to a server
                // For this demo, we'll simulate a server response
                await new Promise(resolve => setTimeout(resolve, 1500));

                // Generate a shareable URL
                const url = `https://governmentassessment.vercel.app/shared/${pageId}?lang=${language}`;

                // Update the share dialog
                shareUrl.value = url;

                // Show the share dialog
                shareContainer.classList.add('visible');
            } catch (error) {
                console.error('Error sharing page:', error);
                alert('Failed to share page. Please try again.');
            } finally {
                // Hide loading overlay
                loadingOverlay.classList.remove('visible');
            }
        });

        // Template buttons
        templateBasicTsx.addEventListener('click', function() {
            codeEditor.value = templates['basic-tsx'];
            languageSelect.value = 'tsx';
            updatePreview();
        });

        templateChart.addEventListener('click', function() {
            codeEditor.value = templates['chart'];
            languageSelect.value = 'tsx';
            updatePreview();
        });

        templateLegislative.addEventListener('click', function() {
            codeEditor.value = templates['legislative'];
            languageSelect.value = 'tsx';
            updatePreview();
        });

        // Close share dialog
        closeButton.addEventListener('click', function() {
            shareContainer.classList.remove('visible');
        });

        // Copy URL to clipboard
        copyButton.addEventListener('click', function() {
            // Use modern clipboard API if available
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(shareUrl.value)
                    .then(() => {
                        // Show toast notification
                        toast.classList.add('visible');
                        setTimeout(() => {
                            toast.classList.remove('visible');
                        }, 3000);
                    })
                    .catch(err => {
                        console.error('Failed to copy: ', err);
                        // Fallback to older method
                        fallbackCopy();
                    });
            } else {
                // Fallback for browsers that don't support clipboard API
                fallbackCopy();
            }

            function fallbackCopy() {
                // Copy the URL to clipboard using older method
                shareUrl.select();
                try {
                    const successful = document.execCommand('copy');
                    if (successful) {
                        // Show toast notification
                        toast.classList.add('visible');
                        setTimeout(() => {
                            toast.classList.remove('visible');
                        }, 3000);
                    } else {
                        console.error('Fallback: Copying text failed');
                    }
                } catch (err) {
                    console.error('Fallback: Unable to copy', err);
                }
            }
        });

        // Close share dialog when clicking outside
        shareContainer.addEventListener('click', function(event) {
            if (event.target === shareContainer) {
                shareContainer.classList.remove('visible');
            }
        });

        // Tab key in code editor
        codeEditor.addEventListener('keydown', function(e) {
            if (e.key === 'Tab') {
                e.preventDefault();
                
                // Get cursor position
                const start = this.selectionStart;
                const end = this.selectionEnd;
                
                // Insert 2 spaces for tab
                const spaces = '  ';
                
                // If there's a selection, handle it differently
                if (start !== end) {
                    const lines = this.value.substring(start, end).split('\n');
                    const indentedLines = lines.map(line => spaces + line);
                    const indentedText = indentedLines.join('\n');
                    
                    // Replace the selection with indented text
                    this.value = this.value.substring(0, start) + indentedText + this.value.substring(end);
                    
                    // Adjust selection to maintain the same text selected
                    this.selectionStart = start;
                    this.selectionEnd = start + indentedText.length;
                } else {
                    // No selection, just insert spaces at cursor
                    this.value = this.value.substring(0, start) + spaces + this.value.substring(end);
                    
                    // Move cursor after inserted spaces
                    this.selectionStart = this.selectionEnd = start + spaces.length;
                }
            }
        });

        // Auto-save functionality
        function saveToLocalStorage() {
            try {
                localStorage.setItem('code-editor-content', codeEditor.value);
                localStorage.setItem('language-select', languageSelect.value);
            } catch (e) {
                console.error('Failed to save to localStorage:', e);
            }
        }

        // Load from localStorage
        function loadFromLocalStorage() {
            try {
                const savedCode = localStorage.getItem('code-editor-content');
                const savedLanguage = localStorage.getItem('language-select');
                
                if (savedCode) {
                    codeEditor.value = savedCode;
                }
                
                if (savedLanguage) {
                    languageSelect.value = savedLanguage;
                }
            } catch (e) {
                console.error('Failed to load from localStorage:', e);
            }
        }

        // Set up auto-save
        codeEditor.addEventListener('input', saveToLocalStorage);
        languageSelect.addEventListener('change', saveToLocalStorage);

        // Initial loading
        document.addEventListener('DOMContentLoaded', function() {
            loadFromLocalStorage();
            setTimeout(updatePreview, 500);
        });

        // Also run immediately in case DOMContentLoaded already fired
        setTimeout(updatePreview, 500);
    </script>
</body>
</html>
